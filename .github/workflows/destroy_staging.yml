name: 'Clean up staging'

on:
  pull_request:
    types: [unlabeled, closed]

concurrency:
  group: staging-${{ github.ref }}

jobs:
  clean-up:
    if: |
      (github.event.action == 'unlabeled' && startsWith(github.event.label.name, ':rocket: deploy')) ||
      (github.event.action == 'closed' && (contains(github.event.pull_request.labels.*.name, ':rocket: deploy') || contains(github.event.pull_request.labels.*.name, ':rocket: deploy-ceramic') || contains(github.event.pull_request.labels.*.name, ':rocket: deploy-scoutgame') || contains(github.event.pull_request.labels.*.name, ':rocket: deploy-sunnyawards') || contains(github.event.pull_request.labels.*.name, ':rocket: deploy-comingsoon') || contains(github.event.pull_request.labels.*.name, ':rocket: deploy-farcaster') || contains(github.event.pull_request.labels.*.name, ':rocket: deploy-cron') || contains(github.event.pull_request.labels.*.name, ':rocket: deploy-waitlist') || contains(github.event.pull_request.labels.*.name, ':rocket: deploy-websockets')))
    runs-on: ubuntu-latest
    steps:
      - name: configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: inject slug/short variables
        uses: rlespinasse/github-slug-action@v4.x
        with:
          short-length: 7

      - name: set STAGE variable in environment for next steps
        run: |
          full_stage_name="${{ github.event.number }}-${{ env.GITHUB_HEAD_REF_SLUG }}"

          # sanitize and trim string so that it can be used as a valid subdomain. Includes removing hyphens at the start and end of the name
          stage_name=`echo "$full_stage_name" | sed -E -e 's/[^a-zA-Z0-9-]+//g' -e 's/(.{40}).*/\1/' -e 's/^-/0/' -e 's/-$/0/'`

          # export the stage name so that it can be used in other steps
          echo "STAGE_SUFFIX=$stage_name" >> $GITHUB_ENV

      - name: checkout the files
        uses: actions/checkout@v4

      - name: Install dependencies
        uses: ./.github/actions/install

      - name: destroy the stack on AWS
        # we need to create a dummy zip file or else cdk throws an error it cannot find the asset
        run: |
          touch stg-ceramic-${{ env.STAGE_SUFFIX }}.zip
          touch stg-comingsoon-${{ env.STAGE_SUFFIX }}.zip
          touch stg-cron-${{ env.STAGE_SUFFIX }}.zip
          touch stg-farcaster-${{ env.STAGE_SUFFIX }}.zip
          touch stg-scoutgame-${{ env.STAGE_SUFFIX }}.zip
          touch stg-sunnyawards-${{ env.STAGE_SUFFIX }}.zip
          touch stg-waitlist-${{ env.STAGE_SUFFIX }}.zip
          touch stg-webapp-${{ env.STAGE_SUFFIX }}.zip
          touch stg-websockets-${{ env.STAGE_SUFFIX }}.zip

          npx cdk destroy -c name=stg-ceramic-${{ env.STAGE_SUFFIX }} --force
          npx cdk destroy -c name=stg-comingsoon-${{ env.STAGE_SUFFIX }} --force
          npx cdk destroy -c name=stg-cron-${{ env.STAGE_SUFFIX }} --force
          npx cdk destroy -c name=stg-farcaster-${{ env.STAGE_SUFFIX }} --force
          npx cdk destroy -c name=stg-scoutgame-${{ env.STAGE_SUFFIX }} --force
          npx cdk destroy -c name=stg-sunnyawards-${{ env.STAGE_SUFFIX }} --force
          npx cdk destroy -c name=stg-waitlist-${{ env.STAGE_SUFFIX }} --force
          npx cdk destroy -c name=stg-webapp-${{ env.STAGE_SUFFIX }} --force
          npx cdk destroy -c name=stg-websockets-${{ env.STAGE_SUFFIX }} --force

      - name: delete ceramic github deployment
        uses: strumwolf/delete-deployment-environment@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment: stg-ceramic-${{ env.STAGE_SUFFIX }}

      - name: delete coming soon github deployment
        uses: strumwolf/delete-deployment-environment@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment: stg-comingsoon-${{ env.STAGE_SUFFIX }}

      - name: delete cron github deployment
        uses: strumwolf/delete-deployment-environment@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment: stg-cron-${{ env.STAGE_SUFFIX }}

      - name: delete farcaster github deployment
        uses: strumwolf/delete-deployment-environment@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment: stg-farcaster-${{ env.STAGE_SUFFIX }}

      - name: delete scoutgame github deployment
        uses: strumwolf/delete-deployment-environment@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment: stg-scoutgame-${{ env.STAGE_SUFFIX }}

      - name: delete sunnyawards github deployment
        uses: strumwolf/delete-deployment-environment@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment: stg-sunnyawards-${{ env.STAGE_SUFFIX }}

      - name: delete waitlist github deployment
        uses: strumwolf/delete-deployment-environment@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment: stg-waitlist-${{ env.STAGE_SUFFIX }}

      - name: delete webapp github deployment
        uses: strumwolf/delete-deployment-environment@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment: stg-webapp-${{ env.STAGE_SUFFIX }}

      - name: delete websockets github deployment
        uses: strumwolf/delete-deployment-environment@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment: stg-websockets-${{ env.STAGE_SUFFIX }}
